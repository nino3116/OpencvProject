<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="">
    <title>Camera ê´€ë¦¬</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body class="container mt-4">
    <h2 class="mb-4">ğŸ“· Camera ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>

    <form id="addForm" class="mb-4">
      <div class="row">
        <div class="col">
          <input
            type="text"
            id="cam_name"
            class="form-control"
            placeholder="ì¹´ë©”ë¼ ì´ë¦„"
            required
          />
        </div>
        <div class="col">
          <input
            type="text"
            id="cam_group"
            class="form-control"
            placeholder="ì¹´ë©”ë¼ ê·¸ë£¹"
          />
        </div>
        <div class="col">
          <input
            type="number"
            id="num_person"
            class="form-control"
            placeholder="ê°ì§€ ì¸ì› ìˆ˜"
          />
        </div>
        <div class="col">
          <button type="submit" class="btn btn-primary">ì¶”ê°€</button>
        </div>
      </div>
    </form>

    <table class="table table-bordered">
      <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>ì¹´ë©”ë¼ ì´ë¦„</th>
          <th>ê·¸ë£¹</th>
          <th>ê°ì§€ ì¸ì›</th>
          <th>ì‚­ì œ</th>
        </tr>
      </thead>
      <tbody id="cameraTable">
        {% for cam in cams %}
        <tr>
          <td>{{ cam.id }}</td>
          <td contenteditable="true" onBlur="updateCam({{ cam.id }}, this)">  
            {{ cam.cam_name }}
          </td>
          <td contenteditable="true" onBlur="updateCam({{ cam.id }}, this)">
            {{ cam.cam_group }}
          </td>
          <td contenteditable="true" onBlur="updateCam({{ cam.id }}, this)">
            {{ cam.num_person }}
          </td>
          <td>
            <button
              class="btn btn-danger btn-sm"
              onclick="deleteCam({{ cam.id }})"
            >
              ì‚­ì œ
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <script>
      $("#addForm").submit(function (e) {
        e.preventDefault();
        let data = {
          cam_name: $("#cam_name").val(),
          cam_group: $("#cam_group").val(),
          num_person: $("#num_person").val(),
        };
        $.ajax({
          url: "/add",
          type: "POST",
          contentType: "application/json", // JSON í˜•ì‹ìœ¼ë¡œ ì „ì†¡
          data: JSON.stringify(data),
          success: function (response) {
            location.reload();
          },
          error: function (xhr, status, error) {
            console.error("ì¶”ê°€ ì‹¤íŒ¨ : ", error);
          },
        });
      });

      function updateCam(id, element) {
        let column = ["cam_name", "cam_group", "num_person"][
          element.cellIndex - 1
        ];
        let oldValue = element.getAttribute("data-old_value");
        let newValue = element.innerText.trim();

        if (oldValue === newValue) return;

        let data = { [column]: newValue };
        element.setAttribute("data-old_value", newValue);

        $.post(
          `/update/${id}`,
          JSON.stringify(data),
          function() {
            confirm("ìˆ˜ì • ì™„ë£Œí–ˆìŠµë‹ˆë‹¤.");
            console.log("íŒì—… ë‹«í˜");
          },
          "json"
        );
      }

      function deleteCam(id) {
        if (confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
          $.post(`/delete/${id}`, function () {
            location.reload();
          });
        }
      }
    </script>
  </body>
</html>
